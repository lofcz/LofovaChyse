@using DataAccess.Models
@using PerpetuumSoft.Knockout
@using LofovaChyse.Areas.Admin.Controllers
@model IList<Book>

<div id="ajaxContent">

    @{
        ViewBag.Title = "Index";
        //Book book = ViewBag.Kniha as Book; //Přetypování / secure

        // @model book -> Typový model
    }
    <h2>Výpis knih v lofově knihovně</h2>
    <hr />

    <div class="clearfix"></div>
    
    @foreach (Book b in Model)
    {
        <div>
            <div class="card mb-3 h-25 mt-0">
                <div class="card-body">
                    <h4 class="card-title">@b.Name</h4>
                    <h6 class="card-text">@Html.Raw(b.Description)</h6>
                </div>
                <div class="card-footer text-muted">
                    @b.Author, @b.PublishedYear
                    @Html.ActionLink("Číst →", "Detail", "Books", new { id = b.Id, zobrazPopis = true }, new { title = b.Name, @class = "btn btn-primary float-right btn-sm" })
                </div>
            </div>
        </div>
    }

    <table class="table table-bordered table-hover table-condensed">
        <thead>
            <tr>
                <th>Obrázek</th>
                <th>ID</th>
                <th>Název knihy</th>
                <th>Autor</th>
                <th>Rok vydání</th>

                @if (User.Identity.IsAuthenticated)
                {
                    <th>Hodnotit</th>
                }

                @if (User.IsInRole("Knihovnik"))
                {
                    <th><strong>[ACP] Akce</strong></th>
                }
            </tr>

        </thead>

        <tbody>
            @foreach (Book b in Model)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrEmpty(b.ImageName))
                        {
                            <img src="@Url.Content("~/Uploads/Book/" + b.ImageName)" />
                        }
                    </td>
                    <td><a href="@Url.Action("Detail", "Books", new {id = b.Id, zobrazPopis = false})">@b.Id</a></td>
                    <td>@Html.ActionLink(b.Name, "Detail", "Books", new { id = b.Id, zobrazPopis = true }, new { title = b.Name, @class = "" })</td>
                    <td>@b.Author</td>
                    <td>@b.PublishedYear</td>

                    @if (User.Identity.IsAuthenticated)
                    {
                        <td>
                            <p>
                                @Ajax.ActionLink((b.RateValue).ToString(), "Rate", new { id = b.Id }, new AjaxOptions() { UpdateTargetId = "ajaxContent", InsertionMode = InsertionMode.Replace })
                            </p>

                            <p>Celkové hodnocení: @(((LofovaChyse.Controllers.BooksController)ViewContext.Controller).BookRating(b.Id))</p>

                        </td>
                    }

                    @if (User.IsInRole("Knihovnik"))
                    {
                        <td>
                            @Html.ActionLink("Edit", "Edit", "Books", new { id = b.Id }, null)
                            |
                            @Html.ActionLink("Delete", "Delete", "Books", new { id = b.Id }, new { onclick = "return confirm('Opravdu smazat knihu [" + b.Name + "] ?');" })
                        </td>
                    }
                </tr>
            }

        </tbody>
    </table>
</div>