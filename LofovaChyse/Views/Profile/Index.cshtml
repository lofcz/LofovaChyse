@using DataAccess.Models
@using LofovaChyse.Class
@model DataAccess.Models.KnihovnaUser
@{
    ViewBag.Title = "Index";
    ViewBag.Oceneni = General.GetUserOceneni(Model.Login);

    bool areFriends = true;
    bool canAdd = false;

    string friendMessage = "Přihlášení uživatelé si mohou přidat přátele";

    if (User.Identity.IsAuthenticated)
    {
        areFriends = General.UsersAreFrineds(User.Identity.Name, Model.Login);

        if (!areFriends)
        {
            if (Model.Login == User.Identity.Name)
            {
                friendMessage = "Nemůžeš mít sám sebe za přítele";
            }
            else
            {
                friendMessage = "Tohoto člověka si můžeš přidat za přítele";
                canAdd = true;
            }
        }
        else
        {
            bool friendsConfirmed = General.UsersAreFriendsConfirmed(User.Identity.Name, Model.Login);

            if (friendsConfirmed)
            {
                friendMessage = "S tímto člověkem již jsi kamarád";
            }
            else
            {
                friendMessage = "Žádost byla odeslána a čeká na vyřízení";
            }

        }
    }

    List<KnihovnaUserRole> tvojeRole = General.GetUserRoles(Model.Login);

    string profilText = Model.WelcomeText;
    bool popisOk = true;

    if (String.IsNullOrEmpty(profilText))
    {
        profilText = "Tento uživatel nám toho zatím o sobě moc neřekl. Ale můžeš se zeptat!";
        popisOk = false;
    }

}

<style>
    .nadpisProfil {
        display: inline-block;
        font-size: 2.3em;
    }

    .nadpisDalsiInfo {
        display: inline-block;
    }

    .profilHorniPolozky {
        float: right;
        position: relative;
        color: darkgray;

    }

    .profilHorniPolozkyIkony {
        font-size: 2em;
        cursor: pointer;
    }

    .profilHorniPolozkyZamceno {
        opacity: 0.2;
    }

    .profilIkonaAktivni {
        opacity: 1;
        color: #888;
    }

    .profilObrazekVeliky {
        border-radius: 100px;
        border: 1px solid #ddd;
        padding: 5px;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        margin: 30px;

    }

    .profilPredstaveni {   
        position: relative;
        top: 50px;
        font-size: 1.4em;
        display: block;
        padding-right: 10px;
        height: auto;
    }

    .profilKontajnerObrazek {
        display: inline-flex;
        position: relative;
        top: 10px;
    }

    .circle-icon {
        background: #FEFEFE;
        border-radius: 50%;
        text-align: center;
        vertical-align: middle;
        padding: 8px;
        height: 48px !important;
        width: 48px !important;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1), 0 6px 50px 0 rgba(0, 0, 0, 0.1);
    }

    .profilAuthorLine {
        position: relative;
        right: 10px;
        font-size: 0.9em;
        display: block;
        top: 40px;
    }

    #containerAnimated {
        margin: 20px;
        width: 400px;
        height: 8px;
    }

</style>

<script>
    function onAdd() {
        jQuery('#friendRequest').remove();
        swal("Požadavek odeslán", "Dostaneš upozornění jakmile bude vyřízen", "success");
    }
</script>
<div id="ajaxContent">
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-body" id="modalContent">
                </div>
            </div>
        </div>
    </div>

    @if (ViewBag.Owner)
    {
        <h2 class="nadpisProfil">Vítej na svém profilu</h2>
    }
    else
    {
        <h2 class="nadpisProfil">Profil uživatele @Model.Name</h2>
       

        if (canAdd)
        {
            <div id="friendRequest">
                @Ajax.ActionLink("Přidat přítele", "CallGeneral", "Home", new { user1 = User.Identity.Name, user2 = Model.Login }, new AjaxOptions() { }, new { onclick = "onAdd()" })
                <br />
            </div>
        }
    }
    
    <div id="polozkyProfilu" class="profilHorniPolozky">
        
        <div class="profilHorniPolozkyIkony" id="profilIkony">
            <a href="@Url.Action("Index")" title="Profil" data-tippy-placement="bottom"><i class="fas fa-address-card fa-fw profilIkonaAktivni circle-icon"></i></a>
            <a title="Zeď" data-tippy-placement="bottom" onclick="akcePolozkyProfilu(1)"><i class="fas fa-comments fa-fw circle-icon"></i></a>
            <a title="Galerie" data-tippy-placement="bottom" onclick="akcePolozkyProfilu(2)"><i class="fas fa-images fa-fw circle-icon" ></i></a>
            <a title="Snippet" data-tippy-placement="bottom" onclick="akcePolozkyProfilu(3)"><i class="fas fa-file-code fa-fw circle-icon"></i></a>
            <a title="SoundUp" data-tippy-placement="bottom" onclick="akcePolozkyProfilu(4)"><i class="fas fa-music fa-fw circle-icon"></i></a>
        </div>
    </div>

    
    <!-- Obrázek uživatele veliký-->
    <div id="obrazekUzivatele" class="profilKontajnerObrazek">
        <img src="@Url.Content("~/Uploads/KnihovnaUzivateleBig/" + General.GetMiniaturePicture(Model.Login))" class="profilObrazekVeliky"/>
        
        <div>
            <i class="profilPredstaveni">@Html.Raw(profilText)</i>
            
            @if (popisOk)
            { 
                <br />
                <span class="profilAuthorLine"><i>- @Model.Name @Model.Surname</i></span>
            }
        </div>
    </div>
    
    <!-- XP Bar-->
    <div id="containerAnimated">
        
    </div> 
   
    <script >



        $(document).ready(function () {
            var bar = new ProgressBar.Line("#containerAnimated", {
                strokeWidth: 4,
                easing: 'easeInOut',
                duration: 2500,
                color: '#FFEA82',
                trailColor: '#eee',
                trailWidth: 1,
                text: {
                    style: {
                        // Text color.
                        // Default: same as stroke color (options.color)
                        color: '#999',
                        position: 'relative',
                        right: '0',
                        top: '30px',
                        padding: 0,
                        margin: 0,
                        transform: null
                    },
                    autoStyleContainer: false
                },
                svgStyle: {width: '100%', height: '100%'},
                from: {color: '#66666'},
                to: {color: '#00FF00'},
                step: (state, bar) => {
                    bar.path.setAttribute('stroke', state.color);
                    bar.setText('Zkušenosti: ' + Math.round(bar.value() * 100) + ' %');
                }
            });

            bar.animate(1.0);

        var elem = document.getElementById("myBar");

        $("#zkusenostiBar").fadeIn(500);

        var width = 1;
        var id = setInterval(frame, 10);
        function frame() {
            if (width >= 40) {
                clearInterval(id);
            } else {
                width++; 
                elem.style.width = width + '%'; 
            }
        }
    });

        function akcePolozkyProfilu(index) {
            if (index !== 0) {
                if (@Model.AuthLevel == 0) {
                    swal({
                        title: "Nedostatečné ověření",
                        text: '@Html.Raw(Texty.ProfilSluzbyNedostatecneOvereni)',
                        type: 'warning',
                        html: true
                    });
                } else {
                    if (index == 1) {
                        window.location = '@Url.Action("ViewWall", new { id = Model.Id })';
                    }
                }
            }
        }
    </script>

    <p>Seznam tvých rolí:</p>
    <ul>
        @foreach (KnihovnaUserRole r in tvojeRole)
        {
            <li>
                @General.UserRoleName(r)
            </li>
        }
    </ul>

    <div id="moznostiKontaktu">
        <sub><a href="#">Poslat zprávu</a> | <a href="#">Další kontakty</a></sub>

    </div>

    <br />
    <br />
    <sub style="float: right"><strong>Profil</strong> | @Html.ActionLink("Zeď", "ViewWall", new { id = Model.Id }) | Galerie | Snippety</sub>
    <sub>Úroveň ověření: <strong>@Model.AuthLevel</strong> (@Model.Exp xp)</sub> <sub style="float: right">Získaná ocenění:</sub>
    <br />
    <div class="col-sm-12">
        @foreach (KnihovnaOceneni o in ViewBag.Oceneni as List<KnihovnaOceneni>)
        {
            <img src="@Url.Content("~/Uploads/Odznaky/" + o.Image)" class="animated" style="float: right" title="@o.Name" data-tippy-placement="bottom" onclick="openModelWindow()" id="loadPartialView" mydata="@o.Id" />
        }
        <br />
    </div>
    <br />
    <sub>Přidal se: @Model.JoinedDateTime</sub>
    @if (ViewBag.Owner)
    {
        <p>Jsi vlastník tohoto profilu!</p>
        <p>Uživatelské ID: @Model.Id</p>
        <p>Heslo: @Model.Password</p>
        <p>Úroveň oprávnění: @Model.Role.RoleDescription</p>
        <p>Zkušenosti: @Model.Exp</p>
        <p>Počet komentářů: @Model.CommentsNumber</p>
        <p>Reputace: @Model.LikesNumber</p>

        <div>
            <p id="ajaxNalada">Nálada: @Model.NeedJob</p>
            <button class="btn btn-default" onclick="openModelWindow()" id="loadPartialView2">[Upravit]</button>
        </div>


        <p>Nastav si text pro návštěvy:</p>
        <div class="row">
            @if (User.Identity.IsAuthenticated)
            {
                using (Html.BeginForm("EditProfile", "Profile", FormMethod.Post, new { @class = "col-md-12", enctype = "multipart/form-data" })) // Umožní zpracovat nahrané soubory
                {
                    <div class="form-group">
                        <div>
                            @Html.TextAreaFor(x => x.WelcomeText, new { @class = "form-control formatedtext" })
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-12">
                            <button type="submit" class="btn btn-default" style="z-index: 1">Upravit text</button>
                        </div>
                    </div>
                }
            }
        </div>

        <script type="text/javascript">
            $(function () {
                $("#welcomeText").html("");
            });

            //  jQuery('#myModal').on('hidden.bs.modal', function () {
            //      location.reload();
            //  })
        </script>

        <style>

            .mce-path { /* CSS */
                display: none !important;
            }
        </style>
        <script src="@Url.Content("~/Scripts/tinymce/tinymce.js")"></script>
        <script>
            tinymce.init({
                selector: '.formatedtext',
                branding: false,
                plugins:
                    'code,emoticons,lists,advlist,autolink,autoresize,autosave,codesample,textcolor,colorpicker,fullscreen,hr,image,link,media,preview,searchreplace,table,textpattern,wordcount',
                toolbar:
                    'image,code,emoticons,bulllist,numlist,restoredraft,codesample,forecolor,backcolor,fullscreen,preview,searchreplace',
                width: '100%',
                language: 'cs'


            });
        </script>
    }
    else
    {
        <hr />
        <p>@Html.Raw(Model.WelcomeText)</p>
    }
</div>

<script type="text/javascript">
    function openModelWindow() {

        jQuery('#myModal').modal('toggle');
    }
</script>

<script>
    tippy('[title]')
</script>

<script type="text/javascript">
    jQuery("#loadPartialView").click(function() {

        var u = jQuery(this).attr('mydata');


        jQuery.get('@Url.Action("Test", "Home")',
            { Id: u },
            function(response) {
                jQuery("#modalContent").html(response);
            });
    });

    jQuery("#loadPartialView2").click(function() {

        jQuery.get('@Url.Action("NastavNaladu", "Home")',
            {},
            function(response) {
                jQuery("#modalContent").html(response);
            });
    });

    //openModelWindow();
</script>

@{
    if (Model.AuthLevel == 0)
    {
        <script>
            $(".profilHorniPolozkyIkony i").addClass("profilHorniPolozkyZamceno");
        </script>
    }
}